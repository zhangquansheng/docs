# SpringBoot2.x 中使用 Redis 的 bitmap

> 位图主要用于快速检索关键字状态，通常要求关键字是一个连续的序列（或者关键字是一个连续序列中的大部分）， 
> 最基本的情况，使用1bit标示一个关键字的状态（可标示两种状态），
> 但根据需要也可以使用2bit（标示4种状态），3bit（标示8种状态）。 
> 位图的主要应用场合：标示连续（或接近连续，即大部分会出现）的关键字序列的状态（状态数/关键字个数 越小越好）。

`Redis` 其实只支持 `5` 种数据类型，并没有 `BitMap` 这种类型，`BitMap` 底层是基于 `Redis` 的字符串类型实现的。

## 应用场景

### 用户签到

很多网站都提供了签到功能，并且需要展示最近一个月的签到情况，这种情况可以使用 BitMap 来实现。
根据日期 offset = （今天是一年中的第几天） % （今年的天数），key = 年份：用户id。

### 用户在线状态

使用日期作为 key，然后用户 id 为 offset，如果当日活跃过就设置为1。

### 统计活跃用户

如果需要提供一个查询当前用户是否在线的接口，也可以考虑使用BitMap 。即节约空间效率又高，只需要一个key，然后用户id为offset，如果在线就设置为1，不在线就设置为0。
具体步骤如下：
- 设置一个key专门用来记录用户日活的，可以使用时间来翻滚比如1号的key为active01.
- 使用每个用户的唯一标识映射一个偏移量，比如使用id，这里可以把id换算成一个数字或直接使用id的二进制值作为该用户在当天是否活跃偏移量
- 用户登录则把该用户偏移量上的位值设置为1
- 每天按日期生成一个位图（bitmap）
- 计算日活则使用bitcount即可获得一个key的位值为1的量
- 计算月活（一个月内登陆的用户去重总数）即可把30天的所有bitmap做or计算，然后再计算bitcount
- 计算留存率（次日留存=昨天今天连续登录的人数/昨天登录的人数） 即昨天的bitmap与今天的bitmap做and计算就是连续登录的再做bitcount就得到连续登录人数，再bitcount得到昨天登录人数，就可以通过公式计算出次日留存。

### 实现布隆过滤器

## bitmap 导致大 KEY

bitmap推荐的偏移量是从1一直累加的，但是计算出的hash值为10位（10亿级别），那么占用的内存大小为239MB，若是计算出的hash值为7位（百万级别）占用的内存大小为124KB。

所以计算偏移量的时候不能无脑的进行hash得到，而是要根据系统情况（百万级别的日活、十万级别日活），进行取余计算，得到合适的偏移量。

解决方案是对数据进行分组在分片：
- 不仅可以避免`bitmap`导致`大key`。
- 避免出现范围用户太多导致查询时出现`热key`。






